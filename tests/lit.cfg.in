import lit.util
import lit.formats

config.name = 'perf-taint'
config.source_root = '@CMAKE_CURRENT_SOURCE_DIR@'
config.test_source_root = os.path.join('@CMAKE_CURRENT_SOURCE_DIR@', 'tests')
# Path to test suite in build directory where tests are executed
config.exec_root = '@CMAKE_CURRENT_BINARY_DIR@'
config.test_exec_root = os.path.join('@CMAKE_CURRENT_BINARY_DIR@', 'tests')
# Help variable used to locate compiled library
config.lib_dir = '@CMAKE_CURRENT_BINARY_DIR@'
config.mpi_link_flags = '@CMAKE_MPI_LINK_FLAGS@'
config.libcxx_path = '@CMAKE_LIBCXX_PATH@'
config.libomp = '@OpenMP_C_LIBRARIES@'
config.suffixes = ['.ll']
config.test_format = lit.formats.ShTest(True)
# TODO: make it configurable

config.substitutions.append( ('%loadpass', '-load '
    + config.lib_dir
    + '/libStaticExtractor.so'
    + ' -extrap-extractor'
    ))

config.substitutions.append( ('%dfsan', '-load '
    + config.lib_dir
    + '/libDfsanInstrument.so'
    + ' -extrap-extractor'
    + ' -dfsan'
    + ' -dfsan-abilist=%s/share/dfsan_abilist.txt' % config.source_root
    )
)

config.substitutions.append( ('%mpidfsan', '-load '
    + config.lib_dir
    + '/libDfsanInstrument.so'
    + ' -extrap-extractor'
    + ' -extrap-extractor-func-database=%s/share/mpi_abilist.txt' % config.source_root
    + ' -dfsan'
    + ' -dfsan-abilist=%s/share/dfsan_abilist.txt' % config.source_root
    )
)

config.substitutions.append( ('%llcparams',
    '-relocation-model=pic'
    + ' -filetype=obj'
    )
)

config.substitutions.append( ('%link',
    '-stdlib=libc++'
    + ' -fsanitize=dataflow'
    + ' -fsanitize-blacklist=%s/share/dfsan_abilist.txt' % config.source_root
    + ' -L%s' % config.libcxx_path
    + ' -Wl,--start-group,-lc++abi'
    + ' %s' % config.mpi_link_flags
    + ' %s/libdfsan_runtime.a' % config.exec_root
    )
)

config.substitutions.append( ('%testdir',
    config.test_exec_root
    )
)

config.substitutions.append( ('%execparams',
    'DFSAN_OPTIONS=warn_unimplemented=0'
    )
)

config.substitutions.append( ('%omplink',
    '%s' % config.libomp
    )
)

config.substitutions.append( ('%jsonconvert',
    config.lib_dir
    + '/JSONConverter'
    )
)
